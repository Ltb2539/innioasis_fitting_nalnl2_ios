# 如何运行单元测试

本指南将帮助你在 Xcode 中设置并运行 `TestModuleTests` 单元测试。

## 📋 前提条件

- Xcode 11.0 或更高版本
- 项目已正确配置

## 🚀 步骤 1: 在 Xcode 中添加测试 Target

### 方法一：通过 Xcode 界面添加（推荐）

1. **打开项目**
   - 在 Xcode 中打开 `DCTestUniPlugin.xcodeproj`

2. **添加测试 Target**
   - 点击菜单栏：`File` → `New` → `Target...`
   - 在模板选择器中，选择 `iOS` → `Unit Testing Bundle`
   - 点击 `Next`

3. **配置测试 Target**
   - **Product Name**: `DCTestUniPluginTests`
   - **Language**: `Objective-C`
   - **Target to be Tested**: 选择 `DCTestUniPlugin`
   - 确保 `Include Unit Tests` 已勾选
   - 点击 `Finish`

4. **添加测试文件到 Target**
   - 在项目导航器中，找到 `DCTestUniPluginTests/TestModuleTests.m`
   - 选中文件，在右侧的 `File Inspector` 中
   - 在 `Target Membership` 部分，确保 `DCTestUniPluginTests` 已勾选

## 🔧 步骤 2: 配置测试 Target 的构建设置

1. **选择测试 Target**
   - 在项目导航器中，点击项目名称（最顶部的蓝色图标）
   - 在 `TARGETS` 列表中选择 `DCTestUniPluginTests`

2. **配置 General 设置**
   - 在 `General` 标签页中：
     - **Deployment Target**: 设置为与主 target 相同（通常是 11.0 或更高）

3. **配置 Build Settings**
   - 切换到 `Build Settings` 标签页
   - 搜索并配置以下设置：

   **a. Header Search Paths（头文件搜索路径）**
   ```
   $(SRCROOT)/DCTestUniPlugin
   $(SRCROOT)/../SDK/inc
   ```

   **b. Framework Search Paths（框架搜索路径）**
   ```
   $(SRCROOT)/DCTestUniPlugin/NAL_NL2_SDK
   $(PROJECT_DIR)/DCTestUniPlugin/NAL_NL2_SDK
   ```

   **c. Other Linker Flags（其他链接器标志）**
   ```
   -framework NAL_NL2
   ```

4. **添加依赖和链接**
   - 切换到 `Build Phases` 标签页
   - 展开 `Link Binary With Libraries`
   - 点击 `+` 按钮，添加：
     - `DCTestUniPlugin.framework`（从项目中选择）
     - `NAL_NL2.framework`（如果需要）
   - 展开 `Dependencies`
   - 点击 `+` 按钮，添加 `DCTestUniPlugin` target

## 📝 步骤 3: 配置 Scheme

1. **编辑 Scheme**
   - 点击 Xcode 顶部工具栏中的 Scheme 选择器（项目名称旁边）
   - 选择 `Edit Scheme...`

2. **配置 Test 操作**
   - 在左侧选择 `Test`
   - 在右侧的 `Testables` 部分，确保 `DCTestUniPluginTests` 已勾选
   - 点击 `Close`

## ▶️ 步骤 4: 运行测试

### 方法一：运行所有测试
- 按快捷键：`⌘ + U` (Command + U)
- 或点击菜单：`Product` → `Test`

### 方法二：运行单个测试方法
1. 在 `TestModuleTests.m` 文件中
2. 找到你想运行的测试方法（例如 `testLmsToNalWithProvidedParameters`）
3. 点击方法名左侧的菱形图标 ▶️
4. 或右键点击方法名，选择 `Run "testLmsToNalWithProvidedParameters"`

### 方法三：运行测试类
1. 在 `TestModuleTests.m` 文件中
2. 找到类名 `@interface TestModuleTests`
3. 点击类名左侧的菱形图标 ▶️

## 📊 查看测试结果

测试运行后，你可以在以下位置查看结果：

1. **测试导航器**
   - 按 `⌘ + 6` 打开测试导航器
   - 查看所有测试的状态（✅ 通过 / ❌ 失败）

2. **控制台输出**
   - 在 Xcode 底部的控制台中查看详细的日志输出
   - 测试代码会输出详细的调试信息，包括：
     - 输入参数详情
     - 函数执行时间
     - 返回结果的详细解析
     - 每个频率点的增益值
     - 统计信息（最小值、最大值、平均值）

3. **报告导航器**
   - 按 `⌘ + 9` 打开报告导航器
   - 查看测试运行的详细报告

## 🐛 常见问题排查

### 问题 1: 找不到 TestModule.h
**解决方案：**
- 检查 `Header Search Paths` 是否正确配置
- 确保路径包含 `DCTestUniPlugin` 目录

### 问题 2: 链接错误（Undefined symbols）
**解决方案：**
- 确保在 `Build Phases` → `Link Binary With Libraries` 中添加了 `DCTestUniPlugin.framework`
- 检查 `Dependencies` 中是否添加了 `DCTestUniPlugin` target

### 问题 3: 找不到 NAL_NL2 framework
**解决方案：**
- 检查 `Framework Search Paths` 是否正确配置
- 确保 `NAL_NL2.framework` 的路径正确

### 问题 4: 测试运行时崩溃
**解决方案：**
- 检查控制台中的错误信息
- 确保 `NALNL2Bundle.bundle` 的资源文件存在
- 检查 framework 是否正确链接

## 📱 测试输出说明

测试运行时会输出详细的调试信息：

```
╔════════════════════════════════════════════════════════════╗
║           开始测试 lmsToNal 函数                          ║
╚════════════════════════════════════════════════════════════╝

📥 输入参数详情:
   ├─ age: 20 (岁)
   ├─ gender: 1 (1=男性, 0=女性)
   ├─ isLeft: NO (NO=右耳, YES=左耳)
   ├─ level: 80 (dB)
   └─ ac数组: [45, 55, 55, ...]

📤 返回结果 (JSON 字符串):
[结果数组]

📋 详细数据:
   [0]    125Hz: XX dB
   [1]    250Hz: XX dB
   ...

📈 统计信息:
   ├─ 最小值: XX dB
   ├─ 最大值: XX dB
   └─ 平均值: XX.XX dB
```

## 🎯 测试方法说明

### 1. `testLmsToNalWithProvidedParameters`
- **主要测试方法**，使用你提供的参数
- 验证函数返回结果的格式和数值范围
- 显示详细的统计信息

### 2. `testLmsToNalWithLeftEar`
- 测试左耳情况（`isLeft = YES`）
- 验证左耳参数处理是否正确

### 3. `testLmsToNalWithDifferentLevels`
- 测试不同 level 值（50, 60, 70, 80, 90, 100）
- 对比不同 level 对结果的影响

### 4. `testLmsToNalPerformance`
- 性能测试
- 测量函数执行时间

## 💡 提示

- 首次运行测试时，Xcode 可能需要一些时间来编译和链接
- 如果测试失败，查看控制台中的详细错误信息
- 可以在测试方法中设置断点进行调试
- 使用 `⌘ + Y` 可以切换断点的启用/禁用

## 📚 更多资源

- [Xcode Testing Guide](https://developer.apple.com/documentation/xcode/testing-your-apps-in-xcode)
- [XCTest Framework](https://developer.apple.com/documentation/xctest)

---

**祝你测试顺利！** 🎉

